# 第16题详细解答：脚本编辑器（交互与体验）

> 题干：脚本编辑功能的交互设计有什么特点？如何提升用户编辑体验？（考察点：编辑器开发、可用性与性能、与业务联动）

## 面试者视角（怎么答）

### 1) 目标与角色
- 角色：脚本 = 可分行/分段的文本结构，与角色/语音/镜头/时长联动。
- 目标：高效输入（键盘流）、精准选区（行/词/时间映射）、低成本重排（拖拽/批量）、强反馈（实时预览/同步）。

### 2) 交互设计
- 分行与段落：Enter 换行、Shift+Enter 段内换行；支持批量粘贴自动分行与去空白。
- 行级属性：为每行设置角色、音色（TTS）、语言、时长（字数/语速推算），支持快捷键切换。
- 选择与操作：多选（Shift/Command）、批量删除/合并/拆分；拖拽排序带吸附指示。
- 时间映射：行 ↔ 时间的映射表（基于字数与语速或 TTS 返回的时轴），滚动同步波形/预览。
- 辅助：字数/时长计数、敏感词/重复词高亮、拼写/语法提示、模板变量补全。

### 3) 性能与工程
- 虚拟化：长脚本只渲染可视区域，按行高度缓存；滚动时增量更新。
- 增量 diff：编辑只重算受影响的行与后续偏移，不全量重排；推送变化到预览最小化。
- 可撤销：命令栈（添加/删除/合并/拆分/排序）+ 快照阈值；跨页/刷新可恢复草稿。

### 4) 与业务联动
- TTS 与时轴：一键批量 TTS，返回每行/词的时间戳用于嘴型/镜头对齐；失败行重试。
- 角色/镜头：行为角色绑定（演员/声音），镜头建议（按句长/停顿自动插入 B-roll）。
- 模板变量：与模板系统对接，脚本中使用 `{{name}}/{{brand}}` 等占位，预览中替换。

### 5) 小结（30s）
- “脚本编辑器以行级为核心，提供多选/拖拽/批处理，虚拟化与增量计算确保性能；与 TTS/预览/模板联动，支持时间映射与角色设置，提升编辑效率与可控性。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- 虚拟化如何实现？
  - 考点：行高测量/缓存、可视窗口计算、滚动节流、选择/拖拽在虚拟化场景下的坐标映射。
- 撤销与重做？
  - 考点：命令模式、快照策略、跨页草稿持久化、冲突合并。
- 时间映射的精度？
  - 考点：语速模型/语言差异、TTS 返回时轴、对嘴与镜头同步。
- 批量操作的边界？
  - 考点：合并/拆分的规则、标点/空白处理、属性继承。
- 性能瓶颈与指标？
  - 考点：长文 5k+ 行、输入延迟、滚动掉帧、内存占用。

### 评估要点
- 是否兼顾流畅输入与大文档；是否有与 TTS/预览/模板的闭环；是否有撤销/草稿与性能度量。

### 红旗信号
- 没有虚拟化导致卡顿；时间映射拍脑袋；批量操作破坏数据一致性。

---

## 代码与配置片段
```ts
// 行数据结构
export interface ScriptLine { id: string; text: string; role?: string; voice?: string; lang?: string; estMs?: number }
export interface ScriptDoc { lines: ScriptLine[]; updatedAt: number }
```
```ts
// 估算时长（简化：按字数与语速）
export function estimateMs(text: string, wpm=180){
  const words = text.trim().split(/\s+/).filter(Boolean).length
  return Math.max(500, Math.round((words/ (wpm/60)) * 1000))
}
```
```ts
// 命令模式（示例）
interface Cmd { do(): void; undo(): void }
class CmdStack{ private s:Cmd[]=[]; private i=-1; push(c:Cmd){ this.s.splice(this.i+1); this.s.push(c); this.i++; c.do() } undo(){ if(this.i>=0) this.s[this.i--].undo() } redo(){ if(this.i+1<this.s.length) this.s[++this.i].do() } }
```

---

## 实战建议
- 统一行 ID 与顺序索引；用 Map 提升查找性能；选择/拖拽使用稳定数据源。
- TTS 时轴要与编辑器异步解耦；分批请求并缓存；失败重试。
- 对长文开启虚拟化与键入合并（debounce），避免频繁重排。

## 常见坑
- 复制粘贴未清理空白/格式；拖拽跨虚拟边界错位；撤销/重做遗失选择状态。

## 总结
- 脚本编辑器的关键是“行级模型 + 高效交互 + 虚拟化性能 + 与 TTS/预览的闭环”，保证可用性与稳定性。
