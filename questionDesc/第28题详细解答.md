# 第28题详细解答：埋点系统设计（准确性与完整性）

> 题干：埋点系统的设计思路是什么？如何保证埋点的准确性和完整性？（考察点：数据埋点、用户行为分析、数据质量）

## 面试者视角（怎么答）

### 1) 采集层
- 统一 SDK：`track(event, props)`、`identify(user)`、`page(screen)`；支持 SPA/MPA。
- 自动采集：PV/停留/曝光（IO）/错误；手动采集关键行为。
- 上下文：会话/设备/版本/地域；隐私合规（匿名化/同意管理）。

### 2) 传输层
- 批量上报：队列＋批量发送；离线缓存；失败重试与退避；采样率控制。
- 去重：事件 `idempotencyKey`；重复提交合并。

### 3) 质量保障
- 规范：事件字典（name、属性 schema、取值范围）；SDK 校验属性与必填；CI 校验未注册事件禁止上报。
- 监控：丢包率/延迟/错误率；多端一致性；黑名单（异常客户端）。

### 4) 小结（30s）
- “统一 SDK + 事件字典 + 批量与离线 + 采样与去重，配合 CI 与看板守护数据质量与完整性，确保分析可信。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- 事件字典如何维护？
  - 考点：schema 与审核；自动生成文档；版本管理。
- 批量/离线/采样策略？
  - 考点：阈值、退避、网络/设备差异、GDPR 同意。
- 数据校验与回放？
  - 考点：SDK 校验、后端 schema 校验、回放与修正。

### 评估要点
- 是否 SDK 统一；是否有字典/校验；是否有丢包与延迟监控。

### 红旗信号
- 随意埋点；字段随意；无采样无批量；高丢包不感知。

---

## 代码与配置片段
```ts
// track（简化）
export function track(name: string, props: Record<string, any> = {}){
  queue.push({ name, props, ts: Date.now(), id: crypto.randomUUID() })
  if (queue.length >= 20) flush()
}
```
```ts
// 曝光上报（IntersectionObserver）
const io = new IntersectionObserver(([e])=>{ if(e.isIntersecting) track('exposure', { id: e.target.id }) }, { threshold: 0.5 })
```

---

## 实战建议
- 建立埋点字典与审查流程；小范围试点 + 回放验证；重要事件双通道校验（服务器侧对账）。

## 常见坑
- 埋点重名/属性不一致；上报风暴；离线丢失；未考虑同意与隐私。

## 总结
- 埋点系统要“统一、可验证、可度量、合规”，才能支撑后续分析与决策。
