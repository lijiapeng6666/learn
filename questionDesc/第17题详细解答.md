# 第17题详细解答：实时预览（模板编辑与性能）

> 题干：模板编辑时的实时预览是如何实现的？性能如何保证？（考察点：实时渲染、状态同步、性能优化）

## 面试者视角（怎么答）

### 1) 架构
- 双通道：编辑态（表单/脚本）与预览态（渲染树）解耦，通过“上下文对象”传递数据。
- 渲染器：组件树 / Canvas / WebGL / Video 合成，根据模板类型选择；可降级到占位图/低清。

### 2) 状态同步
- 最小化 diff：对编辑变化做字段级 diff，只把变化 patch 到预览上下文；避免全量重渲染。
- 节流/合并：键入合并（如 200ms），拖拽/滑杆用 `requestAnimationFrame` 节流；批量更新后一次性刷新。
- Worker 分流：复杂计算（布局、滤镜、字幕排版）放到 Web Worker，主线程只做合成。

### 3) 性能
- 视图虚拟化：列表/长文本/时间线虚拟化；Canvas 层用裁剪与增量绘制。
- 资源管理：图片/字体/视频按需加载与缓存；优先加载可见资源；低清预览 + 高清导出。
- 调度：高优（用户交互）> 中优（小更新）> 低优（预加载/缓存）；使用微任务/宏任务合理分配。

### 4) 一致性与验证
- 预览≈渲染：共享渲染引擎或约束能力，保证线上导出结果与预览一致；用截图/像素 diff 校验。
- 错误与兜底：渲染失败时显示占位 + 日志，避免阻塞编辑；提供“刷新预览”与“回退版本”。

### 5) 小结（30s）
- “我们将编辑与预览解耦，通过字段级 diff 与节流/Worker 分流实现实时反馈；资源按需与虚拟化保证性能，预览与导出共享渲染路径并用像素对比验证一致性。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- diff 粒度与策略？
  - 考点：字段级/节点级/片段级、key 管理、Patch 准确性与顺序。
- 资源加载与缓存？
  - 考点：LRU/弱引用缓存、占位与渐进清晰度、失败重试。
- Worker 与主线程分工？
  - 考点：消息协议、拷贝/转移、同步点与一致性、错误回传。
- 一致性验证？
  - 考点：像素对比、阈值与容忍、差异定位；不同平台的编解码偏差处理。
- 监控与指标？
  - 考点：FPS/长任务/内存、首帧时间、用户交互时延。

### 评估要点
- 是否有 diff/节流/Worker 的完整方案；是否处理资源与一致性；是否有监控。

### 红旗信号
- 每次改动全量重渲染；未处理资源失败；预览与导出差异大。

---

## 代码与配置片段
```ts
// 上下文与订阅（简化）
interface PreviewContext { title: string; color: string; image?: string }
const ctx = reactive<PreviewContext>({ title:'', color:'#000' })
function patch(fields: Partial<PreviewContext>){ Object.assign(ctx, fields) }
```
```ts
// 键入合并（节流）
function onInputChange(key: keyof PreviewContext, val: any){
  clearTimeout((onInputChange as any)._t)
  ;(onInputChange as any)._t = setTimeout(()=> patch({ [key]: val } as any), 200)
}
```
```ts
// Worker 计算（示例）
const worker = new Worker(new URL('./layout.worker.ts', import.meta.url))
worker.postMessage({ type:'layout', payload: { text, width } })
worker.onmessage = (e)=> { patch({ layout: e.data }) }
```

---

## 实战建议
- 统一预览上下文与 Patch API；所有编辑操作只通过 Patch 改变上下文。
- 明确优先级队列；用户交互期间暂停低优任务；长任务分片。
- 建立“预览一致性榜单”：版本/模板维度的像素差统计与报警。

## 常见坑
- 未做节流导致输入卡顿；资源复用差导致频繁重载；Worker 与主线程不同步导致闪烁。

## 总结
- 实时预览的关键是“数据驱动 + 最小化更新 + 合理调度 + 一致性验证”。
