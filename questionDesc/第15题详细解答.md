# 第15题详细解答：视频轮播优化（移动端）

> 题干：视频轮播功能在移动端有什么性能考虑？如何优化加载和播放？（考察点：移动端视频优化、内存与带宽管理）

## 面试者视角（怎么答）

### 1) 关键目标
- 首屏快：首张卡片海报与首段视频“可播即显”；
- 内存稳：仅保留可视/邻近 1–2 个视频的解码缓冲；
- 带宽省：按网络与分辨率自适应，避免同时多流下载。

### 2) 加载与播放策略
- 惰性加载：IntersectionObserver 进入可视区才挂载 `<video>`，提前 1 屏预创建/预缓冲下一条。
- 自动播放与静音：`muted` + `playsinline` + 首次交互解锁；失败回退为点击播放。
- 分辨率自适应：按 DPR/屏宽选择 360p/540p/720p；弱网降码率；WIFI 可预缓冲更多。
- 暂停不可见：离开可视区立即 `pause()` 并 `src=''` 或 `pause+unload` 释放缓冲；切换后延迟 100–200ms 再加载下一个，避免抖动。
- 复用实例：复用有限数量的 `<video>` 容器与 HLS 实例，切换时只换 `src`，减少节点与解码器创建。

### 3) 网络与缓存
- CDN 与 preconnect：静态域名预连接，HLS 分片多域并发；设置合理缓存头与 Range 请求。
- 预取节流：仅对下一个候选视频 `prefetch`；弱网禁用预取或降低优先级。
- 首图与占位：海报图 webp/avif，先占位后切为视频帧；降低布局抖动。

### 4) 稳定性与兼容
- iOS 自动播放限制与省电模式：首触发后播放；后台/锁屏暂停；音量键与静音键策略。
- HLS/MSE 兼容：iOS 原生 HLS，Android/桌面用 hls.js；不支持时回退 MP4 渐进下载。
- 错误与重试：分片 404/超时重试；断网暂停并提示；失败卡片可点击重试。

### 5) 小结（30s）
- “我们用 IO 惰性加载 + 邻近预缓冲 + 分辨率自适应，配合不可见暂停与实例复用控制内存与带宽；HLS/MSE 兼容与失败重试确保稳定，首图占位与 preconnect 提升首屏可感知速度。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- 惰性加载边界与阈值？
  - 考点：IO rootMargin、预加载数量、切换节流。
- 内存与解码器使用？
  - 考点：同时解码实例数、释放策略、`src=''` 与 `load()` 的差异。
- 带宽策略？
  - 考点：ABR、自适应清晰度、预取优先级、弱网降级。
- 兼容路径？
  - 考点：iOS 原生 HLS、安卓 hls.js、MP4 回退、自动播放限制处理。
- 崩溃/卡顿如何监控？
  - 考点：内存峰值/播放错误率/首帧时间、RUM 分桶（机型/网络）、重试率与放弃率。

### 评估要点
- 是否有可视区控制与预加载；是否控制解码实例与缓存；弱网/兼容与错误处理是否覆盖。

### 红旗信号
- 同时加载多视频导致带宽争用；不可见视频仍播放；清晰度写死；iOS 自动播放未处理。

---

## 代码与配置片段
```ts
// 惰性加载与可见性控制（Vue）
const onIntersect = (el: HTMLVideoElement, cb: (visible:boolean)=>void) => {
  const io = new IntersectionObserver(([e])=> cb(e.isIntersecting), { rootMargin: '200px 0px' })
  io.observe(el)
  return () => io.disconnect()
}
```
```ts
// 切换时复用 video 实例
let pool: HTMLVideoElement[] = []
function getVideo(){ return pool.pop() || document.createElement('video') }
function releaseVideo(v: HTMLVideoElement){ v.src=''; v.removeAttribute('src'); v.load(); pool.push(v) }
```
```html
<!-- video 属性建议 -->
<video muted playsinline preload="metadata" poster="/img/poster.avif"></video>
```
```ts
// HLS 兼容
import Hls from 'hls.js'
function attachHls(video: HTMLVideoElement, src: string){
  if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = src; return }
  if (Hls.isSupported()) { const h = new Hls(); h.loadSource(src); h.attachMedia(video); return }
  video.src = src.replace('.m3u8','.mp4') // 回退
}
```

---

## 实战建议
- 限制同屏“可播放”实例数量（如 <=2）；切换时先停旧后加载新，避免短时并发。
- 按网络/设备动态选择清晰度；弱网关闭预取；WIFI 可多缓冲一条。
- 监控首帧时间/播放错误率/内存峰值；建立崩溃回溯与自动降级。

## 常见坑
- 预加载过度导致首屏带宽不足；切卡时未释放缓冲；HLS 与 MP4 源混用 CORS 不一致导致失败。

## 总结
- 移动端视频轮播的核心是“可见性驱动的加载播放 + 资源与内存治理 + 兼容与降级”，以稳定流畅为第一目标。
