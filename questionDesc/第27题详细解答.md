# 第27题详细解答：包体积优化（分析与治理）

> 题干：单页面包体的优化手段有哪些？如何分析和定位体积问题？（考察点：打包分析、体积优化、依赖治理）

## 面试者视角（怎么答）

### 1) 分析与预算
- 建立体积预算（各入口 gzip < 150KB）；CI 生成 bundle 分析图（visualizer/analyzer）并对比历史。

### 2) 优化手段
- 代码分割：路由/组件懒加载；固定 vendor 分组；避免重复打包。
- 依赖治理：去重（alias/dedupe）、替代重库（lodash-es 按需）、移除 CJS、剔除未用的 locales（moment/dayjs）。
- 资源优化：图片/字体子集化；SVG sprite；按需样式。
- 编译优化：移除 dev 代码与调试依赖；`define` 常量裁剪；压缩器参数（esbuild/terser）。

### 3) 验证与回归
- 体积报告与差异阈值；大增量必查；产物哈希漂移监控。

### 4) 小结（30s）
- “通过分割+依赖治理+资源优化+编译裁剪，并以预算与报告守门，稳定控制包体积与回归。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- 重复依赖与多版本？
  - 考点：锁文件与 alias；可视化定位；统一版本策略。
- CJS 与摇树？
  - 考点：ESM 优先、sideEffects 标注、动态导入边界。
- 哈希漂移？
  - 考点：稳定入口、runtime/manifest 提取、deterministicIds。
- vendor 拆分与长缓存策略？
  - 考点：manualChunks/splitChunks 的分组原则、稳定入口与 runtime 拆分、避免跨入口重复（共享依赖归属）、哈希稳定与缓存命中率评估。
- UI 组件库与样式按需？
  - 考点：unplugin-vue-components/auto-import、sideEffects 标注、样式分离与裁剪（Purge/LightningCSS）、全量引入导致的体积放大识别与整改。
- Polyfill 与浏览器目标？
  - 考点：browserslist/target 配置、plugin-legacy 动态注入 vs 全量 polyfill、core-js 污染、可选链/空值合并转译成本、差分构建。
- 国际化与本地化资源？
  - 考点：vue-i18n runtime-only vs full、语言包懒加载与分模块、moment/dayjs locales 剔除策略、日期库替换与插件控制。
- 图标与富组件大包？
  - 考点：iconfont/SVG sprite/按需图标、monaco/highlight.js/echarts/three 等重库的子模块引入、CDN/外部化与动态导入、功能裁剪（workers/languages）。
- 资源内联与阈值？
  - 考点：小图片 base64 内联阈值控制、JSON/字典是否被内联、`assetsInlineLimit` 配置、按路径豁免关键资源。
- CommonJS 摇树失败定位？
  - 考点：commonjsOptions、动态 `require`、默认导出包装导致的死代码无法删、替换为 ESM 或使用 `esbuild` 转换策略。
- CSS 体积回归与关键 CSS？
  - 考点：Critical CSS 抽取、按路由拆分、未使用样式清理、CSS-in-JS 注入成本、原子类/设计令牌的规模控制。
- Source map 与调试产物？
  - 考点：生产是否上传 map、map 独立存储与 gzip、避免将 map 误随产物发布导致体积指标飙升。
### 评估要点
- 是否有报告与预算；是否治理重复与 CJS；是否考虑漂移。

### 红旗信号
- 只靠压缩；无报告；漂移频繁。

---

## 代码与配置片段
```ts
// vite.config.ts（alias 去重）
export default { resolve: { alias: { 'lodash': 'lodash-es' } } }
```
```ts
// dayjs 按需
env.VITE_BUNDLE_LOCALES && dayjs.locale('en')
```

---

## 实战建议
- 依赖白名单与黑名单；大库替代清单；定期清理未使用依赖。

## 常见坑
- 引入 CJS 破坏摇树；动态 import 可变路径；moment 全量 locales。

## 总结
- 包体优化依赖“分析→治理→守门”的闭环，持续迭代而非一次性。
