# 第29题详细解答：异常监控（上报与快速定位）

> 题干：异常上报的机制是怎样的？如何做到异常的快速定位和修复？（考察点：错误监控、告警与追踪、故障处理）

## 面试者视角（怎么答）

### 1) 采集
- 错误：`window.onerror`、`unhandledrejection`、Vue 全局错误钩子、资源加载失败（`error` 捕获）。
- 上下文：版本/路由/用户/设备/网络；最近 breadcrumbs（路由切换、接口请求）。
- Source Map：上传到监控平台；还原堆栈与代码段。

### 2) 上报与采样
- 批量上报、速率限制；同一错误指纹（message+stack）去重；按环境/用户分层采样。

### 3) 定位与修复
- 归因：错误聚类、影响分析（用户数/国家/设备）、首次出现时间；关联发布版本与变更记录。
- 快速回滚：CDN 回滚/灰度回退；热修复（配置开关）绕过风险路径。
- 回归验证：修复后监控指标恢复，关闭告警。

### 4) 小结（30s）
- “全链路采集 + Source Map 还原 + 去重采样 + 影响评估与回滚机制，保障快速定位与恢复。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- 错误指纹算法？
  - 考点：message+stack+文件位置、环境因素剔除、聚类阈值。
- Source Map 安全？
  - 考点：私有存储、访问控制、上传与版本绑定。
- 告警策略？
  - 考点：阈值/分层、重复抑制、值班流程。
- 发布回滚？
  - 考点：灰度、快速回滚、黑名单开关。

### 评估要点
- 是否有 Source Map 与聚类；是否有回滚与告警；是否能量化影响与恢复。

### 红旗信号
- 仅 console 打印；无上报；无回滚；错误泛滥无门槛。

---

## 代码与配置片段
```ts
window.addEventListener('error', (e) => { /* 上报 */ })
window.addEventListener('unhandledrejection', (e) => { /* 上报 */ })
```
```json
// 构建上传 sourcemap（CI）
{ "scripts": { "postbuild": "upload-sourcemap dist --release $VERSION" } }
```

---

## 实战建议
- 错误字典与级别；高优先级错误即时通知；与发布平台打通；演练回滚。

## 常见坑
- 没有 map 无法定位；重复上报风暴；告警疲劳。

## 总结
- 异常监控 = 采集 + 还原 + 聚类 + 告警 + 回滚，形成闭环。
