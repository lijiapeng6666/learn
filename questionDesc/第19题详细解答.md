# 第19题详细解答：国际化架构（Vue-i18n 模块化）

> 题干：Vue-i18n 模块化语言包的具体实现方案是什么？（考察点：国际化实现、模块化与按需加载）

## 面试者视角（怎么答）

### 1) 架构
- 命名空间：`common/feature/page` 分层，key 命名 `ns.path.key`，避免冲突。
- 模块化：每个业务模块自带 `locales/{en,zh,ja,...}.ts`；构建时汇总或运行时按需加载。
- 运行时：默认只加载当前语言与公共模块；进入页面时动态 `import` 该模块语言。

### 2) 加载与缓存
- 按需加载：`setLocale(locale)` 时检查 `availableLocales`，缺失则动态导入并注册。
- 缓存：内存缓存 + 本地版本号；语言切换时预取热门模块语言包。
- 复数/占位：使用 ICU 格式；组件层支持插槽与 `v-i18n` 占位。

### 3) 回退与检测
- 语言检测：浏览器/用户设置/URL 参数；第一次进入时记在 localStorage。
- 回退链：`zh-CN -> zh -> en`；缺失 key 记录上报并在开发态高亮。

### 4) 小结（30s）
- “我们采用命名空间 + 模块化语言包，默认仅加载当前语言与公共模块，页面进入时按需加载对应模块语言，支持 ICU/复数/占位，回退链和缺失上报保证稳定。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- 命名与分层？
  - 考点：命名空间策略、跨模块复用、冲突避免。
- 按需加载细节？
  - 考点：动态 import、预取、版本与缓存、弱网降级。
- 回退与缺失？
  - 考点：fallback 链、缺失上报、构建期校验。
- 文案膨胀与 RTL？
  - 考点：30% 膨胀空间、逻辑属性、RTL 切换。

### 评估要点
- 是否模块化与按需；是否考虑回退与缺失；是否有缓存与版本。

### 红旗信号
- 单一大语言包；无回退与上报；切换卡顿。

---

## 代码与配置片段
```ts
// i18n.ts
import { createI18n } from 'vue-i18n'
export const i18n = createI18n({ legacy: false, locale: 'en', messages: { en: { common: {} } } })

export async function setLocale(locale: string) {
  if (!(i18n.global as any).availableLocales.includes(locale)) {
    const common = await import(`./locales/${locale}/common.ts`)
    i18n.global.setLocaleMessage(locale, { common: common.default })
  }
  i18n.global.locale.value = locale
}
```
```ts
// 页面按需加载模块语言
export async function ensurePageLocale(ns: string, locale: string){
  const cur = i18n.global.getLocaleMessage(locale)
  if (!cur[ns]) {
    const mod = await import(`./locales/${locale}/${ns}.ts`)
    i18n.global.mergeLocaleMessage(locale, { [ns]: mod.default })
  }
}
```

---

## 实战建议
- 构建期校验 key 一致性；缺失 key 自动收集；提供文案预览。
- 对大模块拆分语言文件；热门模块做预取；RTL 切换做回归测试。

## 常见坑
- 语言切换未持久化；重复注册覆盖；ICU 格式错误导致渲染异常。

## 总结
- 国际化架构关键在“命名空间 + 按需加载 + 回退链 + 度量与校验”，保证体验与可维护性。
