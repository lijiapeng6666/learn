# 第18题详细解答：任务中心设计（状态管理与数据同步）

> 题干：任务中心的状态管理和数据同步是如何处理的？（考察点：状态同步、数据一致性、MPA/SPA 差异）

## 面试者视角（怎么答）

### 1) 模型与分层
- 模型：`Task{id,status,progress,type,error,meta,updatedAt}`，索引到列表与详情；支持过滤与分组。
- 分层：Core（跨页共享）任务 Store + Feature（页面内）视图状态；Core 层持久化并跨页同步（BroadcastChannel）。

### 2) 数据来源与融合
- 来源：发起任务的页面回填入中心；后台推送（SSE/WSS）与轮询（兜底）更新；页面进入时做一次“补拉”。
- 去重与合并：以 `taskId` 去重；按 `updatedAt` 或 `version` 合并；状态机控制变更合法性（禁止回退）。

### 3) 前后台与离线
- 可见性：前台正常更新/通知；后台降频或暂停；恢复前台时快速补拉。
- 离线：暂停更新并提示；恢复后短间隔多次拉取补齐。

### 4) 用户体验
- 列表卡片 + 详情：状态、进度、ETA、重试、取消；批量操作；筛选与搜索。
- 通知：完成/失败通知（可选声音），点击跳转；长任务提供预计完成时间。

### 5) 小结（30s）
- “任务中心用 Core Store 跨页共享，推送优先、轮询兜底；以状态机与时间戳合并更新，前后台/离线有差异化策略，提供重试/取消与筛选通知。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- 数据源冲突与合并？
  - 考点：时间戳/版本、状态机合法性、最终一致性、丢失更新处理。
- 推送与轮询的边界？
  - 考点：后端能力/成本、断线重连、长轮询降级。
- 跨页同步？
  - 考点：BroadcastChannel/storage、节流与环回保护、版本迁移。
- 失败与重试策略？
  - 考点：分类、指数退避、用户级限流、幂等。
- 监控与可观测性？
  - 考点：失败率/平均重试次数/完成时长分布、报警与看板。

### 评估要点
- 是否有合并规则与状态机；是否有前后台/离线策略；是否有监控。

### 红旗信号
- 多源互相覆盖；重复项；固定间隔暴力轮询；无重试与取消。

---

## 代码与配置片段
```ts
// Task Store（简化）
export type TaskStatus = 'PENDING'|'QUEUED'|'RUNNING'|'SUCCEEDED'|'FAILED'|'CANCELED'
export interface Task { id:string; type:string; status:TaskStatus; progress?:number; updatedAt:number; error?:string }

const tasks = reactive(new Map<string, Task>())
export function upsert(next: Task){
  const cur = tasks.get(next.id)
  if(!cur || next.updatedAt >= (cur.updatedAt||0)) tasks.set(next.id, { ...cur, ...next })
}
```
```ts
// 跨页同步（BroadcastChannel）
const bc = 'BroadcastChannel' in window ? new BroadcastChannel('task-center') : null
watch(tasks, () => { bc?.postMessage({ t: Date.now(), tasks: Array.from(tasks.values()) }) }, { deep:true })
bc?.addEventListener('message', (e)=>{ for(const t of e.data.tasks) upsert(t) })
```

---

## 实战建议
- 统一状态机与合法转换表；不同来源的更新时间戳与版本对齐；批量化更新。
- 推送优先；轮询只兜底；错误分类与重试标准化；跨页同步做节流与去环回。

## 常见坑
- 重复项/回退状态；推送/轮询覆盖冲突；离线/后台仍高频请求。

## 总结
- 任务中心关键在“模型统一 + 来源融合 + 跨页共享 + 差异化调度 + 可观测性”。
