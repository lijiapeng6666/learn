# 第25题详细解答：图像压缩策略（生产构建）

> 题干：生产构建时的图像压缩是如何实现的？压缩比例如何控制？（考察点：构建优化、图像处理、质量与体积权衡）

## 面试者视角（怎么答）

### 1) 构建期压缩
- Vite 插件：`vite-imagemin`/`@squoosh/lib` 集成，处理 png/jpeg/webp/avif；SVG 压缩用 `svgo`。
- 质量策略：按类型设置目标质量与体积目标（如 jpeg q=0.76、webp q=0.7、avif cq=35）。
- 多尺寸：生成 `@1x/@2x/@3x` 或 `srcset`，移动端按 DPR 选择。

### 2) 运行期与 CDN
- `srcset/sizes` 自适应；关键图 `preload` 与 `fetchpriority`；CDN 按 UA 动态转码（webp/avif）。
- 缓存：内容哈希 + 长缓存；占位图（LQIP/BlurHash）优化感知。

### 3) 验证与回归
- 可视对比：SSIM/PSNR 指标；阈值外报警；自动生成压缩报告。
- 回滚：对个别劣化图保留原图白名单；允许按路径覆盖质量参数。

### 4) 小结（30s）
- “构建期用 imagemin/squoosh 压缩并生成多尺寸，运行期用 srcset 与 CDN 转码，配合哈希缓存与占位图，并用 SSIM 报表监控质量。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- 参数如何定？
  - 考点：样本集实验、PSNR/SSIM 取阈、按场景差异配置。
- 多尺寸与选择？
  - 考点：`srcset/sizes`、DPR/屏宽、带宽自适应。
- SVG 与动画？
  - 考点：svgo 与安全、动图策略（webp 动图/视频）。

### 评估要点
- 是否有实验与报告；是否支持路径级覆盖；是否考虑动画与 SVG。

### 红旗信号
- 固定参数拍脑袋；无质量回归；只管体积不管观感。

---

## 代码与配置片段
```ts
// vite.config.ts（示意）
import viteImagemin from 'vite-plugin-imagemin'
export default {
  plugins: [
    viteImagemin({
      mozjpeg: { quality: 76 },
      pngquant: { quality: [0.65, 0.8] },
      webp: { quality: 70 },
      svgo: { plugins: [{ name: 'removeViewBox', active: false }] }
    })
  ]
}
```
```html
<img src="hero.avif" srcset="hero@1x.avif 1x, hero@2x.avif 2x, hero@3x.avif 3x" sizes="(max-width:600px) 100vw, 600px">
```

---

## 实战建议
- 建立图片清单与差分压缩；大图/首图单独调优；为关键页面做人工验收。

## 常见坑
- 全站统一参数导致某些图劣化；未处理动图；SVG 压缩破坏交互。

## 总结
- 图像压缩的关键是“分类型/分场景参数 + 多尺寸 + 质量回归 + 覆盖与回滚机制”。
