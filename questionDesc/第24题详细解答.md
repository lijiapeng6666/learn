# 第24题详细解答：多业务付费场景（统一抽象与复用）

> 题干：不同付费场景下的前端逻辑是如何统一管理的？（考察点：业务抽象、代码复用、可配置化）

## 面试者视角（怎么答）

### 1) 抽象与模型
- `PayContext{scene:'subscription'|'oneoff'|'topup'|'unlock', productId, amount, currency, meta}`
- `PayFlow` 状态机：`INIT -> CHECK -> PAYING -> VERIFY -> DONE/FAILED/CANCELED`。

### 2) 统一流程
- 检查与引导：场景入参 → 校验权限与配额 → 计算价格/货币 → 展示支付弹窗。
- 支付与验证：调用平台 SDK（Stripe/IAP）→ 回传凭证到后端 → 验证成功后刷新 Entitlement/余额。
- 结果与回退：统一处理成功/失败/取消；记录埋点与错误日志。

### 3) 可配置与扩展
- 产品与定价：配置中心下发（国家/货币/折扣）；界面根据 `scene` 渲染不同 CTA 文案与说明。
- A/B 与灰度：切换支付通道与价格策略；指标闭环。

### 4) 小结（30s）
- “我们用 PayContext+状态机统一订阅/一次性/充值/解锁等流程，支付验证后刷新权益或余额，通用 UI + 场景配置化实现复用与扩展。”

---

## 面试官视角（怎么问、看什么）

### 可追问清单（附考点）
- 场景差异如何抽象？
  - 考点：统一状态机、差异点通过配置/回调。
- 价格/货币与税？
  - 考点：地区差异、税费展示、四舍五入与显示规则。
- 验证与回调？
  - 考点：凭证回传、幂等验证、失败重试与回滚。
- 指标与 A/B？
  - 考点：转化率、支付失败率、回收率、渠道对比。

### 评估要点
- 是否统一状态机；是否考虑地区/税；是否有验证闭环与指标。

### 红旗信号
- 每个场景重写；无验证；失败路径未覆盖。

---

## 代码与配置片段
```ts
// PayFlow（简化）
export type PayState = 'INIT'|'CHECK'|'PAYING'|'VERIFY'|'DONE'|'FAILED'|'CANCELED'
export async function runPay(ctx: PayContext){
  // CHECK
  // ... 校验与拉取价格
  // PAYING
  // ... 调用 SDK
  // VERIFY
  // ... 回传并刷新权益
}
```

---

## 实战建议
- 所有场景进入统一入口；对外提供少量钩子（beforePay/afterVerify）。
- 统一错误码与用户提示；失败可重试与客服入口。

## 常见坑
- 各场景自定义流程导致维护困难；汇率/税费显示错误；验证失败未回收。

## 总结
- 多场景统一的关键是“状态机 + 配置化 + 验证闭环 + 指标驱动”。
