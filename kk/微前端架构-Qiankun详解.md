# å¾®å‰ç«¯æ¶æ„å®Œå…¨æŒ‡å— - Qiankunè¯¦è§£

## ä¸€å¥è¯æ€»ç»“
**å¾®å‰ç«¯ = ä¸€ä¸ªä¸»åº”ç”¨ + å¤šä¸ªå­åº”ç”¨ï¼Œé€šè¿‡ Qiankun æ¡†æ¶å®ç°åº”ç”¨é—´çš„éš”ç¦»ã€é€šä¿¡å’ŒåŠ¨æ€åŠ è½½**

---

## ä»€ä¹ˆæ˜¯å¾®å‰ç«¯ï¼ˆMicro Frontendï¼‰ï¼Ÿ

### å®šä¹‰
å¾®å‰ç«¯æ˜¯ä¸€ç§å°†å‰ç«¯åº”ç”¨åˆ†è§£æˆè‹¥å¹²ä¸ªå°çš„ã€åŠç‹¬ç«‹çš„"å‰ç«¯åº”ç”¨"çš„æ¶æ„é£æ ¼ï¼Œè¿™äº›åº”ç”¨å¯ä»¥ï¼š
- âœ… ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²
- âœ… ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆ
- âœ… ç”±ä¸åŒå›¢é˜Ÿç»´æŠ¤
- âœ… åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½
- âœ… å…±äº«å…¨å±€çŠ¶æ€

### vs. å…¶ä»–æ¶æ„çš„å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡            â”‚ å•ä½“åº”ç”¨SPA  â”‚ å¤šé¡µé¢MPA     â”‚ æ¨¡å—è”é‚¦    â”‚ å¾®å‰ç«¯Qiankunâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åº”ç”¨éš”ç¦»        â”‚ âŒ å¦        â”‚ âœ… æ˜¯        â”‚ âš ï¸ éƒ¨åˆ†     â”‚ âœ… å®Œå…¨     â”‚
â”‚ ç‹¬ç«‹éƒ¨ç½²        â”‚ âŒ å¦        â”‚ âœ… æ˜¯        â”‚ âœ… æ˜¯       â”‚ âœ… æ˜¯       â”‚
â”‚ å›¢é˜Ÿç‹¬ç«‹        â”‚ âŒ å¦        â”‚ âœ… æ˜¯        â”‚ âœ… æ˜¯       â”‚ âœ… æ˜¯       â”‚
â”‚ çŠ¶æ€å…±äº«        â”‚ âœ… å®¹æ˜“      â”‚ âš ï¸ å›°éš¾      â”‚ âš ï¸ å›°éš¾     â”‚ âœ… å®¹æ˜“     â”‚
â”‚ é€šä¿¡ä¾¿åˆ©        â”‚ âœ… åŸç”Ÿ      â”‚ âŒ å›°éš¾      â”‚ âš ï¸ æœ‰ç¼ºé™·   â”‚ âœ… å®Œå–„     â”‚
â”‚ åº”ç”¨å¯åŠ¨é€Ÿåº¦    â”‚ âŒ æ…¢        â”‚ âœ… å¿«        â”‚ âœ… å¿«       â”‚ âœ… å¿«       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¾®å‰ç«¯æ¶æ„æ¼”å˜

```
é˜¶æ®µ1: å•ä½“åº”ç”¨ (æ—©æœŸ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å•ä¸€SPAåº”ç”¨          â”‚
â”‚  â”œâ”€ ç”¨æˆ·æ¨¡å—                â”‚
â”‚  â”œâ”€ è®¢å•æ¨¡å—                â”‚
â”‚  â”œâ”€ æ”¯ä»˜æ¨¡å—                â”‚
â”‚  â””â”€ æŠ¥è¡¨æ¨¡å—                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šæ— æ³•ç‹¬ç«‹å¼€å‘ã€éƒ¨ç½²å›°éš¾

            â†“â†“â†“

é˜¶æ®µ2: å¤šé¡µé¢åº”ç”¨ (MPA)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·é¡µ  â”‚  è®¢å•é¡µ   â”‚  æ”¯ä»˜é¡µ  â”‚  æŠ¥è¡¨é¡µ    â”‚
â”‚  (ç‹¬ç«‹)  â”‚  (ç‹¬ç«‹)   â”‚  (ç‹¬ç«‹)  â”‚  (ç‹¬ç«‹)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šåº”ç”¨é—´é€šä¿¡å›°éš¾ã€çŠ¶æ€å…±äº«å¤æ‚

            â†“â†“â†“

é˜¶æ®µ3: å¾®å‰ç«¯ + Qiankun (ç°ä»£)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä¸»åº”ç”¨ (Base App)                   â”‚
â”‚  â”œâ”€ å…¨å±€çŠ¶æ€ç®¡ç† (Pinia/Vuex)                â”‚
â”‚  â”œâ”€ å…¨å±€é€šä¿¡ (Event Bus)                     â”‚
â”‚  â””â”€ è·¯ç”±ç®¡ç†å’Œåº”ç”¨åˆ‡æ¢                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­åº”ç”¨1    â”‚ å­åº”ç”¨2    â”‚ å­åº”ç”¨3   â”‚ å­åº”ç”¨N â”‚
â”‚ (ç”¨æˆ·ç®¡ç†) â”‚ (è®¢å•ç®¡ç†) â”‚ (æ”¯ä»˜)    â”‚ (æŠ¥è¡¨)  â”‚
â”‚ (ç‹¬ç«‹å¼€å‘) â”‚ (ç‹¬ç«‹å¼€å‘) â”‚ (ç‹¬ç«‹å¼€å‘)â”‚(ç‹¬ç«‹å¼€å‘)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ä¼˜åŠ¿ï¼šéš”ç¦»å®Œå…¨ã€é€šä¿¡ä¾¿åˆ©ã€ç‹¬ç«‹éƒ¨ç½²
```

---

## Qiankun æ¡†æ¶è¯¦è§£

### ä»€ä¹ˆæ˜¯ Qiankunï¼Ÿ

Qiankun æ˜¯ç”±èš‚èšé‡‘æœå¼€æºçš„ä¸€ä¸ªå¾®å‰ç«¯æ¡†æ¶ï¼Œæä¾›ï¼š

```
æ ¸å¿ƒèƒ½åŠ›ï¼š
â”œâ”€ åº”ç”¨æ³¨å†Œå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€ åº”ç”¨éš”ç¦»ï¼ˆJSéš”ç¦»ã€CSSéš”ç¦»ï¼‰
â”œâ”€ åº”ç”¨é€šä¿¡ï¼ˆEmit/Listenï¼‰
â”œâ”€ èµ„æºåŠ è½½ï¼ˆåŠ¨æ€åŠ è½½å­åº”ç”¨èµ„æºï¼‰
â””â”€ æ ·å¼æ²™ç®±ï¼ˆé˜²æ­¢æ ·å¼æ±¡æŸ“ï¼‰
```

### åŸºç¡€æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Qiankun åº”ç”¨ç”Ÿæ€                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸»åº”ç”¨ (Master App)                            â”‚
â”‚  â”œâ”€ æ³¨å†Œå­åº”ç”¨                                   â”‚
â”‚  â”œâ”€ ç›‘å¬å­åº”ç”¨ç”Ÿå‘½å‘¨æœŸ                           â”‚
â”‚  â”œâ”€ å…¨å±€é€šä¿¡é€šé“                                 â”‚
â”‚  â””â”€ å…¬å…±èµ„æºï¼ˆæ ·å¼ã€å¸¸é‡ç­‰ï¼‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­åº”ç”¨1         â”‚  å­åº”ç”¨2         â”‚  å­åº”ç”¨N   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç‹¬ç«‹æ‰“åŒ…     â”‚ ç‹¬ç«‹æ‰“åŒ…      â”‚ ç‹¬ç«‹æ‰“åŒ…   â”‚  â”‚
â”‚  â”‚ ç‹¬ç«‹éƒ¨ç½²     â”‚ ç‹¬ç«‹éƒ¨ç½²      â”‚ ç‹¬ç«‹éƒ¨ç½²   â”‚  â”‚
â”‚  â”‚ ç”Ÿå‘½å‘¨æœŸæ¥å£ â”‚ ç”Ÿå‘½å‘¨æœŸæ¥å£  â”‚ ç”Ÿå‘½å‘¨æœŸæ¥å£ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1ï¸âƒ£ ä¸»åº”ç”¨ (Master/Base App)

**èŒè´£**ï¼š
- æä¾›æ•´ä½“å¸ƒå±€æ¡†æ¶ï¼ˆå¯¼èˆªã€ä¾§è¾¹æ ç­‰ï¼‰
- æ³¨å†Œå’Œç®¡ç†æ‰€æœ‰å­åº”ç”¨
- ç»´æŠ¤å…¨å±€çŠ¶æ€
- å¤„ç†åº”ç”¨é—´é€šä¿¡

**ç¤ºä¾‹ä»£ç **ï¼š
```typescript
// main.ts - ä¸»åº”ç”¨å…¥å£
import { registerMicroApps, start } from 'qiankun'
import { createApp } from 'vue'
import App from './App.vue'

const app = createApp(App)

// 1. å®šä¹‰å­åº”ç”¨åˆ—è¡¨
const apps = [
  {
    name: '@org/user-app',              // å­åº”ç”¨åç§°
    entry: 'http://localhost:8081',     // å­åº”ç”¨å…¥å£åœ°å€
    container: '#user-container',       // æŒ‚è½½å®¹å™¨
    activeRule: '/user'                 // æ¿€æ´»è§„åˆ™ï¼ˆè·¯ç”±åŒ¹é…ï¼‰
  },
  {
    name: '@org/order-app',
    entry: 'http://localhost:8082',
    container: '#order-container',
    activeRule: '/order'
  },
  {
    name: '@org/payment-app',
    entry: 'http://localhost:8083',
    container: '#payment-container',
    activeRule: '/payment'
  }
]

// 2. æ³¨å†Œå­åº”ç”¨
registerMicroApps(apps, {
  beforeLoad: async (app) => {
    console.log('åº”ç”¨åŠ è½½å‰ï¼š', app.name)
  },
  beforeMount: async (app) => {
    console.log('åº”ç”¨æŒ‚è½½å‰ï¼š', app.name)
  },
  afterMount: async (app) => {
    console.log('åº”ç”¨æŒ‚è½½åï¼š', app.name)
  },
  beforeUnmount: async (app) => {
    console.log('åº”ç”¨å¸è½½å‰ï¼š', app.name)
  },
  afterUnmount: async (app) => {
    console.log('åº”ç”¨å¸è½½åï¼š', app.name)
  }
})

// 3. å¯åŠ¨ Qiankun
start()

app.mount('#app')
```

### 2ï¸âƒ£ å­åº”ç”¨ (Micro App)

**èŒè´£**ï¼š
- å¯¼å‡ºç”Ÿå‘½å‘¨æœŸå‡½æ•°
- ç‹¬ç«‹çš„ä¸šåŠ¡é€»è¾‘
- å¯é€‰çš„å…¨å±€é€šä¿¡

**ç¤ºä¾‹ä»£ç **ï¼š
```typescript
// src/main.ts - å­åº”ç”¨å…¥å£
import { createApp } from 'vue'
import { createRouter, createWebHistory } from 'vue-router'
import App from './App.vue'

let instance = null
let router = null
const baseName = window.__POWERED_BY_QIANKUN__ ? '/user' : '/'

function createInstance() {
  const app = createApp(App)

  router = createRouter({
    history: createWebHistory(baseName),
    routes: [
      { path: '/', component: () => import('./pages/Home.vue') },
      { path: '/list', component: () => import('./pages/List.vue') }
    ]
  })

  app.use(router)
  return app
}

// â­ Qiankun ç”Ÿå‘½å‘¨æœŸæ¥å£ï¼ˆå¿…é¡»å¯¼å‡ºï¼‰
export async function bootstrap() {
  console.log('[user-app] åº”ç”¨åˆå§‹åŒ–')
}

export async function mount(props) {
  console.log('[user-app] åº”ç”¨æŒ‚è½½', props)

  // æ¥æ”¶ä¸»åº”ç”¨ä¼ å…¥çš„å‚æ•°
  if (props.onGlobalStateChange) {
    // ç›‘å¬å…¨å±€çŠ¶æ€å˜åŒ–
    props.onGlobalStateChange((state) => {
      console.log('å…¨å±€çŠ¶æ€å˜åŒ–ï¼š', state)
    }, true)
  }

  const app = createInstance()
  app.mount('#app')
  instance = app
}

export async function unmount() {
  console.log('[user-app] åº”ç”¨å¸è½½')
  instance?.unmount()
  instance = null
}

export async function update(props) {
  console.log('[user-app] åº”ç”¨æ›´æ–°', props)
}

// å¼€å‘ç¯å¢ƒï¼ˆä¸é€šè¿‡ Qiankun åŠ è½½ï¼‰ç‹¬ç«‹è¿è¡Œ
if (!window.__POWERED_BY_QIANKUN__) {
  createInstance().mount('#app')
}
```

### 3ï¸âƒ£ åº”ç”¨é€šä¿¡

#### æ–¹å¼1: å…¨å±€çŠ¶æ€ç®¡ç†

```typescript
// ä¸»åº”ç”¨ï¼šsrc/stores/globalState.ts
import { initGlobalState } from 'qiankun'

const initialState = {
  user: null,
  theme: 'light',
  language: 'zh'
}

// åˆå§‹åŒ–å…¨å±€çŠ¶æ€
const { onGlobalStateChange, setGlobalState } = initGlobalState(initialState)

// ç›‘å¬å…¨å±€çŠ¶æ€å˜åŒ–
onGlobalStateChange((state) => {
  console.log('å…¨å±€çŠ¶æ€å·²å˜åŒ–ï¼š', state)
})

// è®¾ç½®å…¨å±€çŠ¶æ€
export function updateUserInfo(userInfo) {
  setGlobalState({ user: userInfo })
}

export { onGlobalStateChange, setGlobalState }
```

```typescript
// å­åº”ç”¨ï¼šsrc/composables/useGlobalState.ts
import { ref } from 'vue'

export function useGlobalState(props) {
  const globalState = ref(null)

  if (props?.onGlobalStateChange) {
    props.onGlobalStateChange((state) => {
      globalState.value = state
      console.log('å­åº”ç”¨æ”¶åˆ°å…¨å±€çŠ¶æ€ï¼š', state)
    }, true)
  }

  const setGlobalState = (state) => {
    if (props?.setGlobalState) {
      props.setGlobalState(state)
    }
  }

  return { globalState, setGlobalState }
}
```

#### æ–¹å¼2: Event Bus é€šä¿¡

```typescript
// ä¸»åº”ç”¨ï¼šsrc/utils/eventBus.ts
type Listener = (...args: any[]) => void

class EventBus {
  private events = new Map<string, Listener[]>()

  on(event: string, listener: Listener) {
    if (!this.events.has(event)) {
      this.events.set(event, [])
    }
    this.events.get(event)!.push(listener)
  }

  emit(event: string, ...args: any[]) {
    if (this.events.has(event)) {
      this.events.get(event)!.forEach(listener => listener(...args))
    }
  }

  off(event: string, listener: Listener) {
    if (this.events.has(event)) {
      const listeners = this.events.get(event)!
      const index = listeners.indexOf(listener)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }
}

export default new EventBus()
```

```typescript
// å­åº”ç”¨ä¸­ä½¿ç”¨
import eventBus from '@parent/utils/eventBus'

export function useEventBus() {
  const emit = (event: string, data: any) => {
    eventBus.emit(event, data)
  }

  const on = (event: string, callback: Function) => {
    eventBus.on(event, callback)
  }

  return { emit, on }
}
```

---

## åº”ç”¨éš”ç¦»æœºåˆ¶

### JS éš”ç¦»

Qiankun æä¾›ä¸¤ç§éš”ç¦»æ–¹å¼ï¼š

```typescript
// 1. SnapshotSandboxï¼ˆå¿«ç…§æ²™ç®±ï¼‰- æ€§èƒ½ä¸€èˆ¬
// æ–¹å¼ï¼šä¿å­˜åŠ è½½å‰åçš„windowå¯¹è±¡å¿«ç…§ï¼Œå¯¹æ¯”å·®å¼‚

// 2. ProxySandboxï¼ˆä»£ç†æ²™ç®±ï¼‰- æ¨èä½¿ç”¨
// æ–¹å¼ï¼šä½¿ç”¨ Proxy ä»£ç† window å¯¹è±¡ï¼Œé˜²æ­¢æ±¡æŸ“å…¨å±€å˜é‡

// é…ç½®ç¤ºä¾‹ï¼š
registerMicroApps(apps, {
  sandbox: {
    strictStyleIsolation: false,    // CSSä¸¥æ ¼éš”ç¦»
    experimentalStyleIsolation: true // å®éªŒæ€§CSSéš”ç¦»
  }
})
```

### CSS éš”ç¦»

```css
/* æ ·å¼å†²çªé—®é¢˜ç¤ºä¾‹ */

/* ä¸»åº”ç”¨çš„ global.css */
button {
  background: blue;
  color: white;
}

/* å­åº”ç”¨çš„ style.css */
button {
  background: red;        /* ä¼šè¦†ç›–ä¸»åº”ç”¨æ ·å¼ï¼ */
  color: black;
}

/* è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ BEM å‘½åè§„èŒƒ */
.user-app__button {
  background: red;
  color: black;
}

.order-app__input {
  border: 1px solid #ccc;
}

/* æˆ–ä½¿ç”¨ CSS Modules */
// UserApp.module.css
.button {
  background: red;
}

// ä½¿ç”¨æ—¶ï¼š
import styles from './UserApp.module.css'
<button :class="styles.button">Click</button>
```

---

## è·¯ç”±è®¾è®¡

### è·¯ç”±è§„åˆ’æœ€ä½³å®è·µ

```
ä¸»åº”ç”¨è·¯ç”±ï¼š
/                          â† é¦–é¡µ
/user/*                    â† ç”¨æˆ·åº”ç”¨çš„æ‰€æœ‰è·¯ç”±
/order/*                   â† è®¢å•åº”ç”¨çš„æ‰€æœ‰è·¯ç”±
/payment/*                 â† æ”¯ä»˜åº”ç”¨çš„æ‰€æœ‰è·¯ç”±

å­åº”ç”¨å†…éƒ¨è·¯ç”±ï¼š
/user/profile              â† ç”¨æˆ·ä¸ªäººä¸­å¿ƒ
/user/settings             â† ç”¨æˆ·è®¾ç½®
/order/list                â† è®¢å•åˆ—è¡¨
/order/detail/:id          â† è®¢å•è¯¦æƒ…
```

### å®ç°ç¤ºä¾‹

```typescript
// ä¸»åº”ç”¨ï¼šsrc/router/index.ts
import { createRouter, createWebHistory } from 'vue-router'

const routes = [
  {
    path: '/',
    component: () => import('@/layouts/BaseLayout.vue'),
    children: [
      { path: '', component: () => import('@/pages/Home.vue') },
      // å­åº”ç”¨è·¯ç”±ç”± Qiankun ç®¡ç†ï¼Œè¿™é‡Œåªå®šä¹‰å®¹å™¨
      { path: 'user/:pathMatch(.*)*', component: () => import('@/layouts/MicroAppContainer.vue') },
      { path: 'order/:pathMatch(.*)*', component: () => import('@/layouts/MicroAppContainer.vue') },
      { path: 'payment/:pathMatch(.*)*', component: () => import('@/layouts/MicroAppContainer.vue') }
    ]
  }
]

export const router = createRouter({
  history: createWebHistory('/'),
  routes
})
```

```vue
<!-- MicroAppContainer.vue -->
<template>
  <div id="micro-app-container"></div>
</template>

<script setup lang="ts">
// è¿™ä¸ªå®¹å™¨ä¸­ä¼šåŠ¨æ€æŒ‚è½½ä¸åŒçš„å­åº”ç”¨
</script>

<style scoped>
#micro-app-container {
  width: 100%;
  min-height: calc(100vh - 60px);
}
</style>
```

---

## å®Œæ•´å·¥ä½œæµç¨‹

### åº”ç”¨åŠ è½½æµç¨‹

```
1ï¸âƒ£ ç”¨æˆ·è®¿é—®ä¸»åº”ç”¨
   â†“
2ï¸âƒ£ ä¸»åº”ç”¨åˆå§‹åŒ–ï¼ŒQiankun å¼€å§‹
   â†“
3ï¸âƒ£ ç”¨æˆ·ç‚¹å‡»å¯¼èˆªåˆ° /user
   â†“
4ï¸âƒ£ è·¯ç”±æ¿€æ´»ï¼ŒåŒ¹é…åˆ° /user å­åº”ç”¨
   â†“
5ï¸âƒ£ Qiankun åŠ è½½å­åº”ç”¨èµ„æºï¼ˆHTML/CSS/JSï¼‰
   â†“
6ï¸âƒ£ æ‰§è¡Œå­åº”ç”¨ bootstrap() ç”Ÿå‘½å‘¨æœŸ
   â†“
7ï¸âƒ£ æ‰§è¡Œå­åº”ç”¨ mount(props) ç”Ÿå‘½å‘¨æœŸ
   â†“
8ï¸âƒ£ å­åº”ç”¨æŒ‚è½½åˆ°ä¸»åº”ç”¨å®¹å™¨ä¸­ (#user-container)
   â†“
9ï¸âƒ£ ç”¨æˆ·ä¸å­åº”ç”¨äº¤äº’
   â†“
ğŸ”Ÿ ç”¨æˆ·ç¦»å¼€è¯¥è·¯ç”±
   â†“
1ï¸âƒ£1ï¸âƒ£ æ‰§è¡Œå­åº”ç”¨ unmount() ç”Ÿå‘½å‘¨æœŸ
   â†“
1ï¸âƒ£2ï¸âƒ£ å­åº”ç”¨å¸è½½ï¼Œèµ„æºé‡Šæ”¾
```

---

## å®é™…é¡¹ç›®ç¤ºä¾‹

### æ–‡ä»¶ç»“æ„

```
micro-frontend-app/
â”œâ”€â”€ master-app/                     # ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.ts
â”‚   â”‚   â”œâ”€â”€ App.vue
â”‚   â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”‚   â””â”€â”€ globalState.ts
â”‚   â”‚   â”œâ”€â”€ layouts/
â”‚   â”‚   â”‚   â”œâ”€â”€ BaseLayout.vue
â”‚   â”‚   â”‚   â””â”€â”€ MicroAppContainer.vue
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ Navigation.vue
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â””â”€â”€ eventBus.ts
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ vite.config.ts
â”‚
â”œâ”€â”€ user-app/                       # å­åº”ç”¨1
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.ts                 â­ ç”Ÿå‘½å‘¨æœŸå¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ App.vue
â”‚   â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ Home.vue
â”‚   â”‚   â”‚   â””â”€â”€ Profile.vue
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ vite.config.ts
â”‚
â”œâ”€â”€ order-app/                      # å­åº”ç”¨2
â”‚   â””â”€â”€ ...ï¼ˆç»“æ„åŒä¸Šï¼‰
â”‚
â””â”€â”€ payment-app/                    # å­åº”ç”¨3
    â””â”€â”€ ...ï¼ˆç»“æ„åŒä¸Šï¼‰
```

### æ‰“åŒ…å’Œéƒ¨ç½²é…ç½®

```typescript
// å­åº”ç”¨ Vite é…ç½®ï¼švite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  server: {
    port: 8081,
    headers: {
      'Access-Control-Allow-Origin': '*'  // â­ å…è®¸è·¨åŸŸ
    }
  },
  build: {
    target: 'es2015',
    minify: 'terser',
    lib: {
      entry: 'src/main.ts',
      name: 'userApp',
      fileName: 'userApp'
    },
    rollupOptions: {
      external: ['vue', 'vue-router'],    // â­ å¤–éƒ¨åŒ–ä¾èµ–
      output: {
        globals: {
          vue: 'Vue',
          'vue-router': 'VueRouter'
        }
      }
    }
  }
})
```

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1ï¸âƒ£ é¢„åŠ è½½ (Prefetch)

```typescript
registerMicroApps(
  apps,
  {
    beforeLoad: async (app) => {
      console.log('é¢„åŠ è½½åº”ç”¨ï¼š', app.name)
    }
  },
  {
    'beforeLoad.@org/order-app': async () => {
      console.log('é¢„åŠ è½½è®¢å•åº”ç”¨èµ„æº...')
    }
  }
)

// æ‰‹åŠ¨é¢„åŠ è½½
import { addGlobalUncaughtErrorHandler } from 'qiankun'

setTimeout(() => {
  // åœ¨ç”¨æˆ·é—²æ—¶é¢„åŠ è½½å­åº”ç”¨
  fetch('http://localhost:8082/index.html')
}, 2000)
```

### 2ï¸âƒ£ åŠ¨æ€åŠ è½½ & æ‡’åŠ è½½

```typescript
// åŠ¨æ€æ³¨å†Œå­åº”ç”¨
function registerSubApp(name, entry, activeRule) {
  registerMicroApps([
    {
      name,
      entry,
      container: '#micro-app',
      activeRule
    }
  ])
}

// ä½¿ç”¨æ—¶
import { loadMicroApp } from 'qiankun'

// æ‰‹åŠ¨åŠ è½½ï¼ˆä¸èµ°è·¯ç”±æ¿€æ´»ï¼‰
const app = loadMicroApp({
  name: '@org/payment-app',
  entry: 'http://localhost:8083',
  container: '#payment-dialog'
})

// å¸è½½
app.unmount()
```

### 3ï¸âƒ£ èµ„æºä¼˜åŒ–

```typescript
// ä½¿ç”¨ CDN åŠ é€Ÿ
const apps = [
  {
    name: '@org/user-app',
    entry: 'https://cdn.example.com/user-app/index.html',  // ä½¿ç”¨ CDN
    container: '#user-container',
    activeRule: '/user'
  }
]

// ä»£ç åˆ†å‰²
// åœ¨å­åº”ç”¨ä¸­ä½¿ç”¨åŠ¨æ€ import
const routes = [
  {
    path: '/profile',
    component: () => import('./pages/Profile.vue')  // å¼‚æ­¥åŠ è½½
  },
  {
    path: '/settings',
    component: () => import('./pages/Settings.vue')
  }
]
```

---

## å¸¸è§é—®é¢˜ & è§£å†³æ–¹æ¡ˆ

### Q1: å­åº”ç”¨ä¹‹é—´å¦‚ä½•å…±äº«ä¾èµ–ï¼Ÿ

```typescript
// æ–¹æ¡ˆ1: ä½¿ç”¨ Externalï¼ˆå…±äº«åº“ï¼‰
// ä¸»åº”ç”¨æ³¨å…¥å…¨å±€å˜é‡
window.Vue = Vue
window.VueRouter = VueRouter
window.Pinia = Pinia

// å­åº”ç”¨ vite.config.ts
export default {
  build: {
    rollupOptions: {
      external: ['vue', 'vue-router', 'pinia'],
      output: {
        globals: {
          vue: 'Vue',
          'vue-router': 'VueRouter',
          pinia: 'Pinia'
        }
      }
    }
  }
}

// æ–¹æ¡ˆ2: ä½¿ç”¨ Import Mapï¼ˆæ¨èï¼‰
// ä¸»åº”ç”¨ index.html
<script type="importmap">
{
  "imports": {
    "vue": "https://cdn.jsdelivr.net/npm/vue@3/dist/vue.esm-browser.js",
    "vue-router": "https://cdn.jsdelivr.net/npm/vue-router@4/dist/vue-router.esm-browser.js"
  }
}
</script>
```

### Q2: å¦‚ä½•å¤„ç† CSS æ ·å¼æ±¡æŸ“ï¼Ÿ

```typescript
// æ–¹æ¡ˆ1: CSS æ¨¡å—åŒ–
import styles from './App.module.css'
<div :class="styles.container">...</div>

// æ–¹æ¡ˆ2: BEM å‘½åè§„èŒƒ
<div class="user-app__container">
  <button class="user-app__button">ç‚¹å‡»</button>
</div>

// æ–¹æ¡ˆ3: CSS-in-JS
import styled from 'styled-components'
const Container = styled.div`
  padding: 20px;
  background: #fff;
`

// æ–¹æ¡ˆ4: Qiankun å†…ç½®éš”ç¦»
registerMicroApps(apps, {
  sandbox: {
    experimentalStyleIsolation: true  // å®éªŒæ€§ CSS éš”ç¦»
  }
})
```

### Q3: å¦‚ä½•è°ƒè¯•å­åº”ç”¨ï¼Ÿ

```bash
# æ–¹æ¡ˆ1: ç‹¬ç«‹è¿è¡Œå­åº”ç”¨
cd user-app
npm run dev
# è®¿é—® http://localhost:8081

# æ–¹æ¡ˆ2: ä¿®æ”¹ä¸»åº”ç”¨é…ç½®ï¼ŒåŠ è½½æœ¬åœ°å­åº”ç”¨
// å¼€å‘æ—¶ï¼Œå°†å­åº”ç”¨å…¥å£æ”¹ä¸ºæœ¬åœ° URL
const apps = [
  {
    name: '@org/user-app',
    entry: 'http://localhost:8081',  // æœ¬åœ°å¼€å‘åœ°å€
    container: '#user-container',
    activeRule: '/user'
  }
]

# æ–¹æ¡ˆ3: ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·
// å­åº”ç”¨ä»£ç åœ¨ iframe ä¸­è¿è¡Œæ—¶ä½¿ç”¨ Console è°ƒè¯•
```

### Q4: å­åº”ç”¨å¦‚ä½•è®¿é—®ä¸»åº”ç”¨çš„æ–¹æ³•ï¼Ÿ

```typescript
// æ–¹æ¡ˆ: é€šè¿‡ props ä¼ é€’
// ä¸»åº”ç”¨ï¼šmount æ—¶ä¼ å…¥ props
export async function mount(props) {
  // props ä¸­åŒ…å«ä¸»åº”ç”¨çš„æ–¹æ³•å’Œæ•°æ®
  const { onGlobalStateChange, setGlobalState } = props

  // ä½¿ç”¨ä¸»åº”ç”¨çš„æ–¹æ³•
  onGlobalStateChange((state) => {
    console.log('å…¨å±€çŠ¶æ€å˜åŒ–ï¼š', state)
  })
}
```

---

## vs. å…¶ä»–å¾®å‰ç«¯æ–¹æ¡ˆå¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ         â”‚ Qiankun    â”‚ Module       â”‚ EMP         â”‚ Micro App    â”‚
â”‚              â”‚ (èš‚èšé‡‘æœ) â”‚ Federation   â”‚ (å­—èŠ‚è·³åŠ¨)  â”‚ (ä¹¾å¤æ”¹è¿›ç‰ˆ) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­¦ä¹ æ›²çº¿     â”‚ â­â­â­     â”‚ â­â­        â”‚ â­â­â­      â”‚ â­â­â­      â”‚
â”‚ éš”ç¦»èƒ½åŠ›     â”‚ â­â­â­â­â­ â”‚ â­â­â­       â”‚ â­â­â­â­   â”‚ â­â­â­â­â­ â”‚
â”‚ é€šä¿¡ä¾¿åˆ©åº¦   â”‚ â­â­â­â­   â”‚ â­â­â­       â”‚ â­â­â­â­   â”‚ â­â­â­â­   â”‚
â”‚ ç”Ÿæ€å®Œå–„åº¦   â”‚ â­â­â­â­â­ â”‚ â­â­â­â­     â”‚ â­â­â­      â”‚ â­â­â­â­   â”‚
â”‚ ä½¿ç”¨å¹¿æ³›åº¦   â”‚ â­â­â­â­â­ â”‚ â­â­â­â­â­   â”‚ â­â­â­      â”‚ â­â­â­     â”‚
â”‚ æ‰“åŒ…ä½“ç§¯     â”‚ ä¸­ç­‰       â”‚ è¾ƒå°         â”‚ ä¸­ç­‰        â”‚ ä¸­ç­‰         â”‚
â”‚ è¿è¡Œæ—¶æ€§èƒ½   â”‚ å¥½         â”‚ å¾ˆå¥½         â”‚ å¥½          â”‚ å¾ˆå¥½         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¨èåœºæ™¯ï¼š
âœ… Qiankun       â†’ ä¼ä¸šçº§åº”ç”¨ã€å®Œæ•´å¾®å‰ç«¯æ–¹æ¡ˆ
âœ… Module Fed    â†’ æ„å»ºæ—¶å…±äº«ã€è½»é‡çº§æ–¹æ¡ˆ
âœ… EMP           â†’ è·¨åŸŸåŠ è½½ã€å¤šæŠ€æœ¯æ ˆæ··åˆ
âœ… Micro App     â†’ å¼ºéš”ç¦»éœ€æ±‚ã€ç”Ÿäº§çº§åº”ç”¨
```

---

## æœ€ä½³å®è·µæ€»ç»“

### âœ… DOï¼ˆè¦åšï¼‰

```typescript
// 1. å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°
export async function bootstrap() { }
export async function mount(props) { }
export async function unmount() { }

// 2. ä½¿ç”¨å…¨å±€çŠ¶æ€ç®¡ç†
const { onGlobalStateChange, setGlobalState } = props
onGlobalStateChange((state) => {
  // å“åº”çŠ¶æ€å˜åŒ–
})

// 3. æ ·å¼éš”ç¦»ï¼ˆBEM æˆ– CSS Modulesï¼‰
<div class="app-name__component">...</div>

// 4. ç‹¬ç«‹çš„è·¯ç”±é…ç½®
const router = createRouter({
  history: createWebHistory('/app-name')
})

// 5. é”™è¯¯å¤„ç†
try {
  // åº”ç”¨é€»è¾‘
} catch (error) {
  console.error('å­åº”ç”¨é”™è¯¯ï¼š', error)
}
```

### âŒ DON'Tï¼ˆä¸è¦åšï¼‰

```typescript
// 1. ç›´æ¥ä¿®æ”¹å…¨å±€å¯¹è±¡
âŒ window.globalVar = 'xxx'   // æ±¡æŸ“å…¨å±€

// 2. ä½¿ç”¨å…±äº«çš„å…¨å±€æ ·å¼
âŒ <style>
  button { color: red; }      // ä¼šå½±å“æ‰€æœ‰åº”ç”¨
</style>

// 3. å¿½è§†è·¨åŸŸé—®é¢˜
âŒ <script src="/child-app.js"></script>

// 4. åœ¨ unmount æ—¶ä¸æ¸…ç†
âŒ export async function unmount() {
  // âŒ ç¼ºå°‘æ¸…ç†ä»£ç 
}

// 5. è¿‡åº¦ä¾èµ–ä¸»åº”ç”¨çš„ç§æœ‰æ–¹æ³•
âŒ props.mainAppPrivateMethod()
```

---

## å­¦ä¹ è·¯å¾„

### åˆçº§ï¼šåŸºç¡€æ¦‚å¿µå’Œ Qiankun æ­å»º
- [ ] ç†è§£å¾®å‰ç«¯å®šä¹‰å’Œä¼˜ç¼ºç‚¹
- [ ] äº†è§£ Qiankun æ ¸å¿ƒæ¦‚å¿µ
- [ ] æ­å»ºä¸€ä¸ªç®€å•çš„ä¸»åº”ç”¨ + å­åº”ç”¨
- [ ] å®ç°å­åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸ

### ä¸­çº§ï¼šåº”ç”¨éš”ç¦»å’Œé€šä¿¡
- [ ] ç†è§£ JS éš”ç¦»ï¼ˆProxySandboxï¼‰
- [ ] ç†è§£ CSS éš”ç¦»æœºåˆ¶
- [ ] å®ç°å…¨å±€çŠ¶æ€ç®¡ç†
- [ ] å®ç°åº”ç”¨é—´é€šä¿¡ï¼ˆEvent Busï¼‰
- [ ] å¤„ç†è·¯ç”±å’Œå¯¼èˆª

### é«˜çº§ï¼šæ€§èƒ½ä¼˜åŒ–å’Œç”Ÿäº§éƒ¨ç½²
- [ ] å®ç°å­åº”ç”¨é¢„åŠ è½½å’Œæ‡’åŠ è½½
- [ ] ä¼˜åŒ–åº”ç”¨åŠ è½½æ€§èƒ½
- [ ] å¤„ç†é”™è¯¯å’Œå¼‚å¸¸
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- [ ] ç°åº¦å‘å¸ƒç­–ç•¥

---

## å®ç”¨èµ„æº

### å®˜æ–¹æ–‡æ¡£
- Qiankun å®˜ç½‘ï¼šhttps://qiankun.umijs.org/
- èš‚èšé‡‘æœåˆ†äº«ï¼šhttps://zhuanlan.zhihu.com/p/78362028

### å¼€æºé¡¹ç›®å‚è€ƒ
- qiankun-mainï¼šå®˜æ–¹ç¤ºä¾‹
- micro-appï¼šå­—èŠ‚è·³åŠ¨å¾®åº”ç”¨æ–¹æ¡ˆ
- empï¼šå­—èŠ‚è·³åŠ¨å¾®å‰ç«¯æ–¹æ¡ˆ

### åœ¨çº¿ç¼–è¾‘å™¨
- Codesandboxï¼šå¿«é€ŸéªŒè¯ Qiankun æ¦‚å¿µ
- StackBlitzï¼šå®æ—¶ç¼–è¾‘å’Œè°ƒè¯•

---

## ä¸€å¥è¯æ€»ç»“

**Qiankun é€šè¿‡åº”ç”¨éš”ç¦»ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œçµæ´»é€šä¿¡ï¼Œè®©å¤§å‹å‰ç«¯åº”ç”¨å¯ä»¥åƒæ‹¼ä¹é«˜ä¸€æ ·ï¼Œç”±å¤šä¸ªç‹¬ç«‹å›¢é˜Ÿå¹¶è¡Œå¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²ä¸åŒçš„åŠŸèƒ½æ¨¡å—ï¼Œæœ€åæ— ç¼æ•´åˆåœ¨ä¸€èµ·ã€‚**

å®ƒæ˜¯æ„å»ºç°ä»£åŒ–ã€é«˜æ•ˆèƒ½ä¼ä¸šçº§å‰ç«¯åº”ç”¨çš„æ ¸å¿ƒæ–¹æ¡ˆã€‚
