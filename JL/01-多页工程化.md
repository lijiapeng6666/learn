# 多页工程化：自动发现 41 个页面与构建优化

面向面试官的可讲述版本，包含背景、方案细节、证据点（代码路径）、可量化指标与常见追问的回答建议。

## 背景与目标
- 业务是移动端 WebView 多业务线聚合，页面多、生命周期各自独立；需要降低接入成本与构建体积，并保证可观测。
- 目标：自动发现页面入口、零侵入接入标题/别名；生产构建去冗余、图片压缩、Tailwind 体积可控；首屏指标可上报。

## 方案与实现
- 自动发现与多页构建
  - 扫描 `src/src/pages/**/index.html` 自动生成 `pages` 配置，注入 `entry/template/fileName/title/alias` 等信息；共发现 41 个入口。
  - 关键代码：`src/vue.mulitpage.js`（递归扫描、camelCaseToTitle 生成标题）；`src/vue.mulitpage.js:49` 起构建 `pages` 字段。
  - 佐证：`rg --files -g "src/src/pages/**/index.html"` 统计为 41。
- 构建优化与安全
  - 生产模式使用 `TerserPlugin` 丢弃 `console/debugger`，避免体积与隐私风险（`src/vue.config.js:18` 之后）。
  - 删除 `pefetch/preloadr`，避免移动端带宽竞争（`src/vue.config.js:83`）。
  - 图片处理：`sharp/img-loader` 生产期压缩，识别“动态 WebP”跳过压缩避免损坏（`src/vue.config.js:42` 起 images rule）。
  - SafariNomodule 修正，防止 iOS 低版本加载异常（`src/vue.config.js:12`）。
- Tailwind 体积控制
  - JIT 模式 + safelist，仅保留使用到的原子类（`src/tailwind.config.js`）。
- 首屏可观测
  - 所有入口注入 FCP 监听脚本：在 `configureWebpack` 中 `unshift` 注入 `src/src/utils/reportFcp.ts`（`src/vue.config.js:24` 起）。
  - 通过 Bridge 上报：`src/src/utils/reportFcp.ts` 调用 `clientReportFcp`，再由 `clientBridge.ts` 传至客户端。

## 成果（可量化指标口径）
- 接入成本：新页面仅需 `index.html + main.ts`，自动成为构建入口；迁移/新增人天降低（建议补齐具体值）。
- 体积与首屏：删除 prefetch/preload + 图片压缩 后，首屏请求/总 KB 降低（以 Lighthouse 或 webVitals 为准）。
- 质量：构建过程白名单校验脚本防止外链注入（`src/checkHost.js`）。

## 常见追问与回答建议
- Q：为什么要移除 prefetch/preload？
  - A：移动端弱网下 prefetch 会与关键资源竞争，造成首屏时间抖动；我们通过路由切页再按需加载替代，首屏稳定性更好。
- Q：动态 WebP 为什么要跳过压缩？
  - A：`sharp` 对多帧 WebP 压缩会丢失动画，代码中通过 `metadata.pages > 1` 直接返回原内容。
- Q：多页会导致公共包重复吗？
  - A：依赖仍由 `optimization.splitChunks` 分割（默认策略），公共库进 `chunk-vendors`，重复率低；页面 JS 仅包含差异部分。
- Q：如何接入首屏监控？
  - A：在所有入口前插入 `reportFcp.ts`，使用 webVitals 采集 FCP，延迟 1s 汇报到 Bridge（`clientReportFcp`）。

## 代码证据点（便于面试展示）
- 多页扫描：`src/vue.mulitpage.js`
- 构建优化：`src/vue.config.js`
- FCP 注入与上报：`src/src/utils/reportFcp.ts`, `src/src/utils/clientBridge.ts`
- Tailwind 配置：`src/tailwind.config.js`
- 外链白名单校验：`src/checkHost.js`

