# 生成链路与交互：I2V 参数封装、状态管理与模板流重构

声明边界：生成任务的调度与稳定性主要由客户端实现；前端负责参数封装、交互与回退。本节聚焦前端侧可控的关键点。

## 背景与目标
- Image-to-Video（I2V）涉及多图/描述/模型配置等参数；需要在前端组织参数、校验可用态，并兼容旧版 Android 路由。
- 模板流（Characters/LiveAvatar）需在移动端实现顺滑滚动、稳定曝光与错误回退。

## 方案与实现
- I2V 参数与路由协议
  - 统一在 `useCreateAction.ts` 组装 `templateInfo/imageInfoList/viduInfo` 等参数；根据选择动态追加 `playTypes`，并在 Android 低版本降级路由参数。
  - 校验：描述字数上限、图片是否就绪、免费/付费模型选项、配置保存等；按钮可用态由计算属性集中控制。
  - 关键代码：`src/src/pages/aiVideo/components/ImageToVideo/composables/useCreateAction.ts`。
- 关键状态管理
  - 以 Pinia 切片化存储 I2V 关键状态（双图/上传中/文案等），跨组件共享且避免页面卸载丢失（`src/src/pages/aiVideo/stores/imageToVideoStore.ts`）。
  - 上传与预览：`AdaptiveImage` 组件统一双图展示/右上角操作定位/contain/cover 策略（`src/src/components/AdaptiveImage/index.vue`）。
- 模板流重构
  - 列表：`vue-virtual-scroller` 实现虚拟滚动 + 触底加载（`src/src/pages/liveAvatar/views/TemplateList/index.vue`）。
  - 卡片：动图优先，失败回退静图；`IntersectionObserver` 停留 10s 才上报曝光；宽度测量事件通道稳定布局（`TmpCard.vue` + `useWidthMeasurement.ts`）。

## 成果（口径）
- I2V 交互稳定：参数校验与旧版路由降级减少失败弹窗；用户仅在状态就绪时可发起生成。
- 模板流体验：列表滚动平滑、曝光更准确；动图失败不影响浏览体验。

## 常见追问与回答建议
- Q：你们是否实现了“上传/轮询/重试”的通用引擎？
  - A：重型能力由客户端负责；前端侧提供参数组织、交互校验与异常回退。在文生图模块有本地轮询与重试封装，其余链路走端侧调度。
- Q：10s 曝光为什么不是进入即上报？
  - A：进入即上报容易虚高，10s 停留更能代表真实兴趣，后续转化指标更稳健。
- Q：宽度测量事件通道的价值？
  - A：卡片实际渲染宽度决定了行内布局与虚拟项 size，事件通道让列表根据真实宽度重新计算，减少抖动与错位。

## 代码证据点
- I2V 生成封装：`src/src/pages/aiVideo/components/ImageToVideo/composables/useCreateAction.ts`
- I2V 状态存储：`src/src/pages/aiVideo/stores/imageToVideoStore.ts`
- 图片选择与预览：`src/src/components/AdaptiveImage/index.vue`, `src/src/utils/imageProcess.ts`
- 模板卡片与曝光：`src/src/pages/characters/views/template/components/TmpCard.vue`, `src/src/pages/characters/views/template/composables/useWidthMeasurement.ts`
- 模板列表：`src/src/pages/liveAvatar/views/TemplateList/index.vue`

